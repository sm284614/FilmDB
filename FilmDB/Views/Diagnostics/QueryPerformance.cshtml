@model FilmDB.Controllers.DiagnosticsController.QueryPerformanceModel
@{
    ViewData["Title"] = "Query Performance Profiler";
}

<div class="container mt-4">
    <h1>Query Performance Profiler</h1>
    <p class="text-muted">Database profiling and query performance analysis</p>

    <div class="alert alert-info">
        <strong>Database:</strong> @Model.DatabaseConnectionString
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Run Performance Tests</h5>
            <p class="card-text">Click the button below to run all query performance tests. Each query will be executed 5 times (plus 1 warm-up) to measure average, min, max, and median execution times.</p>
            <form method="post" asp-action="RunQueryTests">
                <button type="submit" class="btn btn-primary">Run Query Performance Tests</button>
            </form>
        </div>
    </div>

    @if (Model.Queries.Any())
    {
        <h2 class="mt-4">Test Results</h2>

        <div class="alert alert-success">
            <strong>✓ Tests completed successfully</strong><br>
            Total queries tested: @Model.Queries.Count<br>
            Successful: @Model.Queries.Count(q => q.Success)<br>
            Failed: @Model.Queries.Count(q => !q.Success)
        </div>

        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Query Name</th>
                    <th>Status</th>
                    <th>Average (ms)</th>
                    <th>Min (ms)</th>
                    <th>Max (ms)</th>
                    <th>Median (ms)</th>
                    <th>Performance Rating</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var query in Model.Queries)
                {
                    <tr>
                        <td><strong>@query.QueryName</strong></td>
                        @if (query.Success)
                        {
                            <td><span class="badge bg-success">Success</span></td>
                            <td>@query.AverageMs.ToString("F2")</td>
                            <td>@query.MinMs</td>
                            <td>@query.MaxMs</td>
                            <td>@query.MedianMs.ToString("F2")</td>
                            <td>
                                @if (query.AverageMs < 50)
                                {
                                    <span class="badge bg-success">Excellent</span>
                                }
                                else if (query.AverageMs < 200)
                                {
                                    <span class="badge bg-info">Good</span>
                                }
                                else if (query.AverageMs < 500)
                                {
                                    <span class="badge bg-warning">Fair</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Slow</span>
                                }
                            </td>
                        }
                        else
                        {
                            <td colspan="5"><span class="badge bg-danger">Failed</span> - @query.ErrorMessage</td>
                        }
                    </tr>
                }
            </tbody>
        </table>

        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Performance Guidelines</h5>
                <ul>
                    <li><span class="badge bg-success">Excellent</span> &lt; 50ms - Query is very fast</li>
                    <li><span class="badge bg-info">Good</span> 50-200ms - Acceptable performance</li>
                    <li><span class="badge bg-warning">Fair</span> 200-500ms - Consider optimization</li>
                    <li><span class="badge bg-danger">Slow</span> &gt; 500ms - Needs optimization or stored procedure</li>
                </ul>
            </div>
        </div>

        <div class="alert alert-primary mt-4">
            <h5>Viewing SQL Queries in Console</h5>
            <p>Check your console output to see the actual SQL queries generated by EF Core. Each query shows:</p>
            <ul>
                <li>The SQL statement executed</li>
                <li>Parameter values</li>
                <li>Execution time</li>
            </ul>
        </div>
    }

    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">SQL Server Profiler Instructions</h5>
            <p>For more detailed profiling using SQL Server Profiler:</p>
            <ol>
                <li>Open SQL Server Management Studio (SSMS)</li>
                <li>Go to <strong>Tools → SQL Server Profiler</strong></li>
                <li>Create a new trace connected to <code>JSX2016\SQLEXPRESS</code></li>
                <li>In the <strong>Events Selection</strong> tab, select:
                    <ul>
                        <li>RPC:Completed</li>
                        <li>SQL:BatchCompleted</li>
                        <li>SQL:BatchStarting</li>
                    </ul>
                </li>
                <li>Add columns: <strong>Duration, Reads, Writes, CPU</strong></li>
                <li>Filter by <strong>DatabaseName = 'FilmDB'</strong></li>
                <li>Start the trace and use your application</li>
            </ol>
        </div>
    </div>
</div>
